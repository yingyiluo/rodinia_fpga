include ../../common/make.config

MAIN = hotspot
KERNEL = $(MAIN)_kernel

ifeq ($(OS),Windows_NT)
	EXE = $(MAIN).exe
else
	EXE = $(MAIN)
endif

ifdef TIME
	CFLAGS += -DTIME=$(TIME)
endif

ifdef SSIZE
	CFLAGS += -DSSIZE=$(SSIZE)
endif

ifdef BSIZE
	CFLAGS += -DBSIZE=$(BSIZE)
	CFLAGS += -DBLOCK_X=$(BSIZE)
	CFLAGS += -DBLOCK_Y=$(BSIZE)
endif

ifdef BLOCK_X
	CFLAGS += -DBLOCK_X=$(BLOCK_X)
endif

ifdef BLOCK_Y
	CFLAGS += -DBLOCK_Y=$(BLOCK_Y)
endif

all: $(EXE)

$(EXE): hotspot.c hotspot.h hotspot_common.h OpenCL_helper_library.c OpenCL_helper_library.h
	$(CXX) $(KERNEL_DIM) $(CFLAGS) -o $(EXE) $(OPENCL_INC) OpenCL_helper_library.c hotspot.c $(LDFLAGS) $(OPENCL_LIB)

clean:
	$(RM) $(EXE) *.aoco $(KERNEL_NAMES)

# Kernel offline compilations

ifndef HOST_ONLY
all: kernel
endif

kernel:

ifdef ALTERA
# default version
v ?= 5
# default block size
BSIZE ?= 32
# default points per stage
SSIZE = 16
# default SIMD size
SIMD ?= 4
# default pipeline replication
CUSIZE ?= 1

# version
KERNEL_VER = $(KERNEL)_v$(v)
KERNEL_VER_AOCO = $(KERNEL_VER)$(PROFILE_SUFFIX).aoco
KERNEL_VER_AOCX = $(KERNEL_VER)$(PROFILE_SUFFIX).aocx
$(KERNEL_VER_AOCO): $(KERNEL_VER).cl
	$(RM) $(KERNEL_VER)$(PROFILE_SUFFIX)
	$(CFPGA) -c $< $(CFPGA_FLAGS) -o $@

# BSIZE
KERNEL_VER_BSIZE = $(KERNEL_VER)_BSIZE$(BSIZE)
KERNEL_VER_BSIZE_AOCO = $(KERNEL_VER_BSIZE)$(PROFILE_SUFFIX).aoco
KERNEL_VER_BSIZE_AOCX = $(KERNEL_VER_BSIZE)$(PROFILE_SUFFIX).aocx
$(KERNEL_VER_BSIZE_AOCO): DEFINE_MACROS += -DBSIZE=$(BSIZE)
$(KERNEL_VER_BSIZE_AOCO): $(KERNEL_VER).cl
	$(RM) $(KERNEL_VER_BSIZE)$(PROFILE_SUFFIX)
	$(CFPGA) -c $< $(CFPGA_FLAGS) -o $@

# SIMD
KERNEL_VER_BSIZE_SIMD = $(KERNEL_VER_BSIZE)_SIMD$(SIMD)
KERNEL_VER_BSIZE_SIMD_AOCO = $(KERNEL_VER_BSIZE_SIMD)$(PROFILE_SUFFIX).aoco
KERNEL_VER_BSIZE_SIMD_AOCX = $(KERNEL_VER_BSIZE_SIMD)$(PROFILE_SUFFIX).aocx
$(KERNEL_VER_BSIZE_SIMD_AOCO): DEFINE_MACROS += -DBSIZE=$(BSIZE) -DSIMD=$(SIMD)
$(KERNEL_VER_BSIZE_SIMD_AOCO): $(KERNEL_VER).cl
	$(RM) $(KERNEL_VER_BSIZE_SIMD)$(PROFILE_SUFFIX)
	$(CFPGA) -c $< $(CFPGA_FLAGS) -o $@

# BSIZE_SIMD_CUSIZE
KERNEL_VER_BSIZE_SIMD_CUSIZE = $(KERNEL_VER_BSIZE)_SIMD$(SIMD)_CUSIZE$(CUSIZE)
KERNEL_VER_BSIZE_SIMD_CUSIZE_AOCO = $(KERNEL_VER_BSIZE_SIMD_CUSIZE)$(PROFILE_SUFFIX).aoco
KERNEL_VER_BSIZE_SIMD_CUSIZE_AOCX = $(KERNEL_VER_BSIZE_SIMD_CUSIZE)$(PROFILE_SUFFIX).aocx
$(KERNEL_VER_BSIZE_SIMD_CUSIZE_AOCO): DEFINE_MACROS += -DBSIZE=$(BSIZE) -DSIMD=$(SIMD) -DCUSIZE=$(CUSIZE)
$(KERNEL_VER_BSIZE_SIMD_CUSIZE_AOCO): $(KERNEL_VER).cl
	$(RM) $(KERNEL_VER_BSIZE_SIMD_CUSIZE)$(PROFILE_SUFFIX)
	$(CFPGA) -c $< $(CFPGA_FLAGS) -o $@


# SSIZE
KERNEL_VER_BSIZE_SSIZE = $(KERNEL_VER_BSIZE)_SSIZE$(SSIZE)
KERNEL_VER_BSIZE_SSIZE_AOCO = $(KERNEL_VER_BSIZE_SSIZE)$(PROFILE_SUFFIX).aoco
KERNEL_VER_BSIZE_SSIZE_AOCX = $(KERNEL_VER_BSIZE_SSIZE)$(PROFILE_SUFFIX).aocx
$(KERNEL_VER_BSIZE_SSIZE_AOCO): DEFINE_MACROS += -DBSIZE=$(BSIZE) -DSSIZE=$(SSIZE)
$(KERNEL_VER_BSIZE_SSIZE_AOCO): $(KERNEL_VER).cl
	$(RM) $(KERNEL_VER_BSIZE_SSIZE)$(PROFILE_SUFFIX)
	$(CFPGA) -c $< $(CFPGA_FLAGS) -o $@

# target definitions
kernel: aocx
ifneq (,$(findstring $(v),1))
aocx: $(KERNEL_VER_AOCX)
aoco: $(KERNEL_VER_AOCO)
else ifneq (,$(findstring $(v),0 3 5))
aocx: $(KERNEL_VER_BSIZE_AOCX)
aoco: $(KERNEL_VER_BSIZE_AOCO)
else ifneq (,$(findstring $(v),2))
aocx: $(KERNEL_VER_BSIZE_SIMD_CUSIZE_AOCX)
aoco: $(KERNEL_VER_BSIZE_SIMD_CUSIZE_AOCO)
else ifneq (,$(findstring $(v),7 9 11))
aocx: $(KERNEL_VER_BSIZE_SSIZE_AOCX)
aoco: $(KERNEL_VER_BSIZE_SSIZE_AOCO)
endif

endif # ifdef ALTERA
